<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Sertlik Kontrol Noktaları</title>
    <link rel="stylesheet" href="styles.css"/>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="header">
        <div class="user-info">
            <span id="current-time"></span>
            <span id="logged-user"></span>
            <img id="logout-button" src="icons/cikis-glohe.png" alt="Çıkış" title="Çıkış"
                 onclick="logout()" style="cursor:pointer;width:30px;height:30px;">
            <button class="btn btn-ghost" onclick="showHomepage()">Anasayfa</button>
        </div>
    </div>

    <aside class="menu">
        <button class="menu-toggle" onclick="toggleMenu()">☰</button>
        <ul>
            <li><a href="klor.html"><img src="icons/klor.png" alt="Klor" title="Klor"><span>Klor</span></a></li>
            <li><a href="sertlik.html"><img src="icons/sertlik.png" alt="Sertlik" title="Sertlik"><span>Sertlik</span></a></li>
            <li><a href="ph.html"><img src="icons/ph.png" alt="Ph" title="Ph"><span>Ph</span></a></li>
            <li><a href="iletkenlik.html"><img src="icons/iletkenlik.png" alt="İletkenlik" title="İletkenlik"><span>İletkenlik</span></a></li>
            <li><a href="mikro.html"><img src="icons/mikro.png" alt="Mikro Biyoloji" title="Mikro Biyoloji"><span>Mikro Biyoloji</span></a></li>
        </ul>
    </aside>

    <div class="content">
        <div class="toolbar">
            <div class="left">
                <h2>Sertlik Kontrol Noktaları</h2>
            </div>
            <div class="right">
                <button class="btn btn-primary" id="btn-open-modal">Yeni Kayıt</button>
                <input class="input" id="search" type="search" placeholder="Kontrol noktası ara..."/>
            </div>
        </div>

        <div id="control-points" class="control-points">
            <div class="grid">
                <div class="box" data-point="Kontrol Noktası 1">Kontrol Noktası 1</div>
                <div class="box" data-point="Kontrol Noktası 2">Kontrol Noktası 2</div>
                <div class="box" data-point="Kontrol Noktası 3">Kontrol Noktası 3</div>
                <div class="box" data-point="Kontrol Noktası 4">Kontrol Noktası 4</div>
                <div class="box" data-point="Kontrol Noktası 5">Kontrol Noktası 5</div>
                <div class="box" data-point="Kontrol Noktası 6">Kontrol Noktası 6</div>
                <div class="box" data-point="Kontrol Noktası 7">Kontrol Noktası 7</div>
                <div class="box" data-point="Kontrol Noktası 8">Kontrol Noktası 8</div>
                <div class="box" data-point="Kontrol Noktası 9">Kontrol Noktası 9</div>
                <div class="box" data-point="Kontrol Noktası 10">Kontrol Noktası 10</div>
                <div class="box" data-point="Kontrol Noktası 11">Kontrol Noktası 11</div>
                <div class="box" data-point="Kontrol Noktası 12">Kontrol Noktası 12</div>
                <div class="box" data-point="Kontrol Noktası 13">Kontrol Noktası 13</div>
            </div>
        </div>
    </div>

    <div class="overlay" id="overlay"></div>
    <div class="modal" id="entry-modal">
        <div class="modal-card">
            <div class="modal-head">
                <h3 class="modal-title">Sertlik Ölçüm Kaydı</h3>
                <button class="btn btn-ghost" id="btn-close-modal">Kapat</button>
            </div>
            <form id="entry-form">
                <div class="modal-body">
                    <div class="form-grid">
                        <div>
                            <label for="point">Kontrol Noktası</label>
                            <select id="point" required>
                                <option value="">Seçiniz...</option>
                                <option>Kontrol Noktası 1</option>
                                <option>Kontrol Noktası 2</option>
                                <option>Kontrol Noktası 3</option>
                                <option>Kontrol Noktası 4</option>
                                <option>Kontrol Noktası 5</option>
                                <option>Kontrol Noktası 6</option>
                                <option>Kontrol Noktası 7</option>
                                <option>Kontrol Noktası 8</option>
                                <option>Kontrol Noktası 9</option>
                                <option>Kontrol Noktası 10</option>
                                <option>Kontrol Noktası 11</option>
                                <option>Kontrol Noktası 12</option>
                                <option>Kontrol Noktası 13</option>
                            </select>
                        </div>

                        <div>
                            <label for="value">Ölçüm Değeri</label>
                            <input id="value" type="number" step="0.1" min="0" placeholder="Örn: 180.0" required/>
                        </div>

                        <div>
                            <label for="unit">Birim</label>
                            <select id="unit" required>
                                <option value="mg/L CaCO₃">mg/L CaCO₃</option>
                                <option value="°fH">Fransız Sertliği (°fH)</option>
                                <option value="°dH">Alman Sertliği (°dH)</option>
                            </select>
                        </div>

                        <div class="full">
                            <label for="note">Açıklama</label>
                            <textarea id="note" rows="3" placeholder="İsteğe bağlı"></textarea>
                        </div>
                        
                        <input type="hidden" id="date" />
                        <input type="hidden" id="time" />
                        <input type="hidden" id="user" />
                    </div>
                </div>
                <div class="modal-foot">
                    <button type="button" class="btn btn-ghost" id="btn-cancel">Vazgeç</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>

    <div class="toast" id="toast">Kayıt başarıyla kaydedildi.</div>

    <script>
        const supabaseClient = window.supabase.createClient(
            'https://mignlffeyougoefuyayr.supabase.co',
            'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1pZ25sZmZleW91Z29lZnV5YXlyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxMzM4NDUsImV4cCI6MjA3NDcwOTg0NX0.WOvAMx4L3IzovJILgwCG7lRZeHhvOl_n7J1LR5A8SX0'
        );

        function checkAuth() {
            const isLoggedIn = localStorage.getItem('isLoggedIn');
            const username = localStorage.getItem('username');
            if (!isLoggedIn) {
                window.location.href = 'index.html';
                return false;
            }
            const userEl = document.getElementById('logged-user');
            if (userEl && username) userEl.textContent = username;
            updateTime();
            setInterval(updateTime, 1000);
            return true;
        }

        function updateTime() {
            const timeEl = document.getElementById('current-time');
            if (timeEl) {
                timeEl.textContent = new Date().toLocaleTimeString('tr-TR', {
                    hour: '2-digit',
                    minute: '2-digit'
                });
            }
        }

        function logout() {
            localStorage.removeItem('isLoggedIn');
            localStorage.removeItem('username');
            window.location.href = 'index.html';
        }

        function showHomepage() {
            window.location.href = 'index.html';
        }

        function toggleMenu() {
            const isMobile = window.matchMedia('(max-width: 768px)').matches;
            if (isMobile) {
                document.body.classList.toggle('mobile-menu-open');
            } else {
                document.body.classList.toggle('menu-collapsed');
            }
        }

        const search = document.getElementById('search');
        const boxes = Array.from(document.querySelectorAll('.box'));
        search.addEventListener('input', () => {
            const q = search.value.toLowerCase().trim();
            boxes.forEach(b => {
                const hit = b.dataset.point.toLowerCase().includes(q);
                b.style.display = hit ? '' : 'none';
            });
        });

        const overlay = document.getElementById('overlay');
        const modal = document.getElementById('entry-modal');
        const btnOpen = document.getElementById('btn-open-modal');
        const btnClose = document.getElementById('btn-close-modal');
        const btnCancel = document.getElementById('btn-cancel');
        const toast = document.getElementById('toast');

        function openModal(prefillPoint) {
            if (prefillPoint) document.getElementById('point').value = prefillPoint;
            
            const now = new Date();
            document.getElementById('date').value = now.toISOString().slice(0,10);
            const hh = String(now.getHours()).padStart(2,"0");
            const mm = String(now.getMinutes()).padStart(2,"0");
            const ss = String(now.getSeconds()).padStart(2,"0");
            document.getElementById('time').value = `${hh}:${mm}:${ss}`;
            
            const userText = (document.getElementById('logged-user')?.textContent || '');
            document.getElementById('user').value = userText || 'Bilinmiyor';

            overlay.style.display = 'block';
            modal.style.display = 'flex';
            document.getElementById('value').focus();
        }

        function closeModal() {
            overlay.style.display = 'none';
            modal.style.display = 'none';
            document.getElementById('entry-form').reset();
        }

        btnOpen.addEventListener('click', () => openModal());
        btnClose.addEventListener('click', closeModal);
        btnCancel.addEventListener('click', closeModal);
        overlay.addEventListener('click', closeModal);

        boxes.forEach(b => b.addEventListener('click', () => openModal(b.dataset.point)));

        const form = document.getElementById('entry-form');
        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            const entry = {
                category: 'Sertlik',
                point: document.getElementById('point').value,
                value: parseFloat(document.getElementById('value').value),
                unit: document.getElementById('unit').value,
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                user: document.getElementById('user').value,
                note: document.getElementById('note').value
            };

            const hardnessValue = entry.value;
            if (hardnessValue < 0) {
                alert('Sertlik değeri 0\'dan büyük olmalıdır.');
                return;
            }

            try {
                const { data, error } = await supabaseClient
                    .from('measurements')
                    .insert([entry])
                    .select();
                
                if (error) {
                    console.error('Kayıt hatası:', error);
                    toast.textContent = 'Kayıt başarısız: ' + error.message;
                    toast.classList.add('show');
                    setTimeout(() => toast.classList.remove('show'), 3000);
                    return;
                }
                
                console.log('Kayıt başarılı:', data);
                closeModal();
                toast.textContent = 'Kayıt başarıyla kaydedildi.';
                toast.classList.add('show');
                setTimeout(() => toast.classList.remove('show'), 3000);
            } catch (err) {
                console.error('Beklenmeyen hata:', err);
                alert('Bir hata oluştu');
            }
        });

        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</body>
</html>