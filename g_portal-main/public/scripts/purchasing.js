// =====================================================
// SATIN ALMA MOD√úL√ú - JAVASCRIPT
// =====================================================

// Global deƒüi≈ükenler
let purchasingOrders = [];
let purchasingSuppliers = [];
let filteredOrders = [];
let currentSortField = 'siparis_tarihi';
let currentSortDirection = 'desc';
let searchQuery = '';

// =====================================================
// VERƒ∞ Y√úKLEME FONKSƒ∞YONLARI
// =====================================================

async function refreshPurchasingData() {
  console.log('üîÑ Satƒ±n alma verileri yenileniyor...');

  try {
    // Sipari≈üleri y√ºkle - SADECE EN G√úNCEL REVƒ∞ZYONLAR (is_latest = true)
    const { data: orders, error: ordersError } = await supabaseClient
      .from('purchasing_orders')
      .select('*')
      .eq('is_latest', true)
      .order('siparis_tarihi', { ascending: false });

    if (ordersError) {
      console.error('Sipari≈ü y√ºkleme hatasƒ±:', ordersError);
      showToast('‚ùå Sipari≈üler y√ºklenemedi: ' + ordersError.message, 'error');
      return;
    }

    purchasingOrders = orders || [];
    console.log(`üì¶ ${purchasingOrders.length} g√ºncel sipari≈ü y√ºklendi`);
    filteredOrders = [...purchasingOrders];

    console.log(`‚úÖ ${purchasingOrders.length} sipari≈ü y√ºklendi`);

    // Tedarik√ßileri y√ºkle
    const { data: suppliers, error: suppliersError } = await supabaseClient
      .from('purchasing_suppliers')
      .select('*')
      .order('tedarikci_tanimi', { ascending: true });

    if (suppliersError) {
      console.error('Tedarik√ßi y√ºkleme hatasƒ±:', suppliersError);
    } else {
      purchasingSuppliers = suppliers || [];
      console.log(`‚úÖ ${purchasingSuppliers.length} tedarik√ßi y√ºklendi`);
    }

    // UI'ƒ± g√ºncelle
    renderPurchasingStats();
    renderPurchasingTable();
    renderPurchasingFilters();

    showToast('‚úÖ Veriler y√ºklendi', 'success');

  } catch (error) {
    console.error('Beklenmeyen hata:', error);
    showToast('‚ùå Beklenmeyen bir hata olu≈ütu', 'error');
  }
}

// =====================================================
// ƒ∞STATƒ∞STƒ∞K KARTLARI
// =====================================================

function renderPurchasingStats() {
  const today = new Date().toISOString().split('T')[0];
  const thisMonth = new Date().toISOString().slice(0, 7);

  // Bug√ºnk√º sipari≈üler
  const todayOrders = purchasingOrders.filter(o => o.siparis_tarihi === today);

  // Bu ayki sipari≈üler
  const monthOrders = purchasingOrders.filter(o =>
    o.siparis_tarihi && o.siparis_tarihi.startsWith(thisMonth)
  );

  // Toplam tutar (TL)
  const totalAmount = monthOrders.reduce((sum, o) => sum + (parseFloat(o.tutar_tl) || 0), 0);

  // Bekleyen sipari≈üler (gelen_miktar < miktar)
  const pendingOrders = purchasingOrders.filter(o =>
    (parseFloat(o.gelen_miktar) || 0) < (parseFloat(o.miktar) || 0)
  );

  const statsHTML = `
    <div class="purchasing-stats-grid">
      <div class="stat-card">
        <div class="stat-icon" style="background: #e3f2fd;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#1976d2" stroke-width="2">
            <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
            <line x1="1" y1="10" x2="23" y2="10"></line>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-label">Bug√ºnk√º Sipari≈üler</div>
          <div class="stat-value">${todayOrders.length}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #f3e5f5;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#7b1fa2" stroke-width="2">
            <path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path>
            <polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline>
            <line x1="12" y1="22.08" x2="12" y2="12"></line>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-label">Bu Ay Toplam</div>
          <div class="stat-value">${monthOrders.length}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #e8f5e9;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2e7d32" stroke-width="2">
            <line x1="12" y1="1" x2="12" y2="23"></line>
            <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-label">Bu Ay Tutar</div>
          <div class="stat-value">${formatCurrency(totalAmount)}</div>
        </div>
      </div>

      <div class="stat-card">
        <div class="stat-icon" style="background: #fff3e0;">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#f57c00" stroke-width="2">
            <circle cx="12" cy="12" r="10"></circle>
            <polyline points="12 6 12 12 16 14"></polyline>
          </svg>
        </div>
        <div class="stat-content">
          <div class="stat-label">Bekleyen Sipari≈üler</div>
          <div class="stat-value">${pendingOrders.length}</div>
        </div>
      </div>
    </div>
  `;

  const contentEl = document.getElementById('purchasing-content');
  if (contentEl) {
    const existingStats = contentEl.querySelector('.purchasing-stats-grid');
    if (existingStats) {
      existingStats.outerHTML = statsHTML;
    } else {
      contentEl.innerHTML = statsHTML + contentEl.innerHTML;
    }
  }
}

// =====================================================
// Fƒ∞LTRE PANELƒ∞
// =====================================================

function renderPurchasingFilters() {
  // Benzersiz tedarik√ßileri al
  const uniqueSuppliers = [...new Set(purchasingOrders.map(o => o.tedarikci_tanimi).filter(Boolean))];

  // Benzersiz √∂deme ko≈üullarƒ±nƒ± al
  const uniquePaymentTerms = [...new Set(purchasingOrders.map(o => o.odeme_kosulu).filter(Boolean))];

  const filtersHTML = `
    <div class="purchasing-filters">
      <h3>Filtreler & Arama</h3>

      <!-- Arama Kutusu -->
      <div class="filter-row search-row">
        <div class="filter-group search-group">
          <label>üîç Hƒ±zlƒ± Arama (Tedarik√ßi, Malzeme, Sipari≈ü No)</label>
          <input
            type="text"
            id="purchasing-search"
            placeholder="Ara..."
            value="${searchQuery}"
            oninput="handlePurchasingSearch(this.value)"
            class="search-input"
          >
        </div>
      </div>

      <!-- Filtreler -->
      <div class="filter-row">
        <div class="filter-group">
          <label>Tedarik√ßi</label>
          <select id="filter-supplier" onchange="applyPurchasingFilters()">
            <option value="">T√ºm√º</option>
            ${uniqueSuppliers.map(s => `<option value="${s}">${s}</option>`).join('')}
          </select>
        </div>

        <div class="filter-group">
          <label>√ñdeme Ko≈üulu</label>
          <select id="filter-payment" onchange="applyPurchasingFilters()">
            <option value="">T√ºm√º</option>
            ${uniquePaymentTerms.map(p => `<option value="${p}">${p}</option>`).join('')}
          </select>
        </div>

        <div class="filter-group">
          <label>Ba≈ülangƒ±√ß Tarihi</label>
          <input type="date" id="filter-date-start" onchange="applyPurchasingFilters()">
        </div>

        <div class="filter-group">
          <label>Biti≈ü Tarihi</label>
          <input type="date" id="filter-date-end" onchange="applyPurchasingFilters()">
        </div>

        <div class="filter-group">
          <button class="btn btn-secondary" onclick="clearPurchasingFilters()">T√ºm√ºn√º Temizle</button>
        </div>
      </div>
    </div>
  `;

  const contentEl = document.getElementById('purchasing-content');
  if (contentEl) {
    const existingFilters = contentEl.querySelector('.purchasing-filters');
    if (existingFilters) {
      existingFilters.outerHTML = filtersHTML;
    } else {
      const statsEl = contentEl.querySelector('.purchasing-stats-grid');
      if (statsEl) {
        statsEl.insertAdjacentHTML('afterend', filtersHTML);
      }
    }
  }
}

function handlePurchasingSearch(value) {
  searchQuery = value.toLowerCase().trim();
  applyPurchasingFilters();
}

function applyPurchasingFilters() {
  const supplier = document.getElementById('filter-supplier')?.value || '';
  const payment = document.getElementById('filter-payment')?.value || '';
  const dateStart = document.getElementById('filter-date-start')?.value || '';
  const dateEnd = document.getElementById('filter-date-end')?.value || '';

  filteredOrders = purchasingOrders.filter(order => {
    // Dropdown filtreler
    if (supplier && order.tedarikci_tanimi !== supplier) return false;
    if (payment && order.odeme_kosulu !== payment) return false;
    if (dateStart && order.siparis_tarihi < dateStart) return false;
    if (dateEnd && order.siparis_tarihi > dateEnd) return false;

    // Arama filtresi
    if (searchQuery) {
      const searchableText = [
        order.siparis_no,
        order.tedarikci_tanimi,
        order.tedarikci_kodu,
        order.malzeme_tanimi,
        order.malzeme,
        order.odeme_kosulu
      ].filter(Boolean).join(' ').toLowerCase();

      if (!searchableText.includes(searchQuery)) return false;
    }

    return true;
  });

  // Sƒ±ralama uygula
  sortPurchasingOrders();

  renderPurchasingTable();
  console.log(`üîç Filtre uygulandƒ±: ${filteredOrders.length}/${purchasingOrders.length} sipari≈ü`);
}

function clearPurchasingFilters() {
  document.getElementById('filter-supplier').value = '';
  document.getElementById('filter-payment').value = '';
  document.getElementById('filter-date-start').value = '';
  document.getElementById('filter-date-end').value = '';
  document.getElementById('purchasing-search').value = '';

  searchQuery = '';
  filteredOrders = [...purchasingOrders];
  sortPurchasingOrders();
  renderPurchasingTable();

  showToast('‚úÖ Filtreler temizlendi', 'success');
}

// =====================================================
// SIRALAMA FONKSƒ∞YONLARI
// =====================================================

function sortPurchasingOrders() {
  filteredOrders.sort((a, b) => {
    let aVal = a[currentSortField];
    let bVal = b[currentSortField];

    // Null deƒüerleri sona at
    if (aVal === null || aVal === undefined) return 1;
    if (bVal === null || bVal === undefined) return -1;

    // Sayƒ±sal kar≈üƒ±la≈ütƒ±rma
    if (typeof aVal === 'number' && typeof bVal === 'number') {
      return currentSortDirection === 'asc' ? aVal - bVal : bVal - aVal;
    }

    // String kar≈üƒ±la≈ütƒ±rma
    aVal = String(aVal).toLowerCase();
    bVal = String(bVal).toLowerCase();

    if (currentSortDirection === 'asc') {
      return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
    } else {
      return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
    }
  });
}

function handleSort(field) {
  if (currentSortField === field) {
    // Aynƒ± alana tƒ±klanƒ±rsa y√∂n√º deƒüi≈ütir
    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
  } else {
    // Farklƒ± alana tƒ±klanƒ±rsa yeni alan ve varsayƒ±lan y√∂n
    currentSortField = field;
    currentSortDirection = 'asc';
  }

  sortPurchasingOrders();
  renderPurchasingTable();
}

// =====================================================
// TABLO RENDER
// =====================================================

function renderPurchasingTable() {
  // Sƒ±ralama oklarƒ± olu≈ütur
  const getSortIcon = (field) => {
    if (currentSortField !== field) {
      return '<span class="sort-icon">‚áÖ</span>';
    }
    return currentSortDirection === 'asc'
      ? '<span class="sort-icon active">‚ñ≤</span>'
      : '<span class="sort-icon active">‚ñº</span>';
  };

  const tableHTML = `
    <div class="purchasing-table-container">
      <h3>Sipari≈üler (${filteredOrders.length})</h3>
      <div class="table-wrapper">
        <table class="purchasing-table">
          <thead>
            <tr>
              <th class="sortable" onclick="handleSort('siparis_no')">
                Sipari≈ü No ${getSortIcon('siparis_no')}
              </th>
              <th class="sortable" onclick="handleSort('siparis_tarihi')">
                Tarih ${getSortIcon('siparis_tarihi')}
              </th>
              <th class="sortable" onclick="handleSort('tedarikci_tanimi')">
                Tedarik√ßi ${getSortIcon('tedarikci_tanimi')}
              </th>
              <th class="sortable" onclick="handleSort('malzeme_tanimi')">
                Malzeme ${getSortIcon('malzeme_tanimi')}
              </th>
              <th class="sortable" onclick="handleSort('miktar')">
                Miktar ${getSortIcon('miktar')}
              </th>
              <th class="sortable" onclick="handleSort('gelen_miktar')">
                Gelen ${getSortIcon('gelen_miktar')}
              </th>
              <th class="sortable" onclick="handleSort('birim_fiyat')">
                Birim Fiyat ${getSortIcon('birim_fiyat')}
              </th>
              <th class="sortable" onclick="handleSort('tutar_tl')">
                Tutar (TL) ${getSortIcon('tutar_tl')}
              </th>
              <th class="sortable" onclick="handleSort('odeme_kosulu')">
                √ñdeme Ko≈üulu ${getSortIcon('odeme_kosulu')}
              </th>
              <th class="sortable" onclick="handleSort('vadeye_gore')">
                Vade Tarihi ${getSortIcon('vadeye_gore')}
              </th>
              <th>Durum</th>
            </tr>
          </thead>
          <tbody>
            ${filteredOrders.length === 0 ? `
              <tr>
                <td colspan="11" style="text-align:center; padding:40px; color:#999;">
                  ${searchQuery ? 'üîç Arama sonucu bulunamadƒ±' : 'Sipari≈ü bulunamadƒ±'}
                </td>
              </tr>
            ` : filteredOrders.map(order => `
              <tr>
                <td>${order.siparis_no || '-'}</td>
                <td>${formatDate(order.siparis_tarihi)}</td>
                <td>${order.tedarikci_tanimi || '-'}</td>
                <td>${order.malzeme_tanimi || '-'}</td>
                <td>${formatNumber(order.miktar)} ${order.birim || ''}</td>
                <td>${formatNumber(order.gelen_miktar)}</td>
                <td>${formatCurrency(order.birim_fiyat)}</td>
                <td>${formatCurrency(order.tutar_tl)}</td>
                <td>${order.odeme_kosulu || '-'}</td>
                <td>${formatVadeDate(order.vadeye_gore)}</td>
                <td>${getOrderStatus(order)}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>
      </div>
    </div>
  `;

  const contentEl = document.getElementById('purchasing-content');
  if (contentEl) {
    const existingTable = contentEl.querySelector('.purchasing-table-container');
    if (existingTable) {
      existingTable.outerHTML = tableHTML;
    } else {
      const filtersEl = contentEl.querySelector('.purchasing-filters');
      if (filtersEl) {
        filtersEl.insertAdjacentHTML('afterend', tableHTML);
      }
    }
  }
}

// =====================================================
// CSV UPLOAD
// =====================================================

function openCSVUpload() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.csv';
  input.onchange = (e) => handleCSVFile(e.target.files[0]);
  input.click();
}

async function handleCSVFile(file) {
  if (!file) return;

  showToast('üì§ CSV dosyasƒ± i≈üleniyor...', 'info');

  try {
    const text = await file.text();
    const orders = parseCSV(text);

    console.log(`üì¶ ${orders.length} sipari≈ü parse edildi`);

    // Kullanƒ±cƒ± email'ini al
    const { data: { user } } = await supabaseClient.auth.getUser();
    const userEmail = user?.email;

    if (!userEmail) {
      showToast('‚ùå Kullanƒ±cƒ± bilgisi alƒ±namadƒ±', 'error');
      return;
    }

    // REVIZYON MANTIƒûI: Her sipari≈ü i√ßin kontrol et ve i≈üle
    const results = await processOrdersWithRevision(orders, userEmail);

    console.log('‚úÖ ƒ∞≈ülem tamamlandƒ±:', results);
    showToast(
      `‚úÖ ${results.inserted} yeni, ${results.updated} g√ºncellendi, ${results.unchanged} deƒüi≈ümedi`,
      'success'
    );
    await refreshPurchasingData();

  } catch (error) {
    console.error('CSV i≈üleme hatasƒ±:', error);
    console.error('Hata stack:', error.stack);
    showToast('‚ùå CSV dosyasƒ± i≈ülenemedi: ' + error.message, 'error');
  }
}

// Revizyon mantƒ±ƒüƒ±yla sipari≈ü i≈üleme
async function processOrdersWithRevision(orders, userEmail) {
  const results = {
    inserted: 0,
    updated: 0,
    unchanged: 0,
    errors: []
  };

  // Her sipari≈ü i√ßin i≈üle
  for (const order of orders) {
    try {
      const orderKey = `${order.siparis_no}-${order.siparis_kalemi || ''}`;

      // Mevcut en g√ºncel kaydƒ± bul
      const { data: existing, error: fetchError } = await supabaseClient
        .from('purchasing_orders')
        .select('*')
        .eq('siparis_no', order.siparis_no)
        .eq('siparis_kalemi', order.siparis_kalemi || '')
        .eq('is_latest', true)
        .single();

      if (fetchError && fetchError.code !== 'PGRST116') {
        // PGRST116 = kayƒ±t bulunamadƒ± (normal)
        console.error(`Hata (${orderKey}):`, fetchError);
        results.errors.push({ order: orderKey, error: fetchError.message });
        continue;
      }

      if (!existing) {
        // YENƒ∞ Sƒ∞PARƒ∞≈û - ƒ∞lk kez ekleniyor
        const newOrder = {
          ...order,
          revision_number: 1,
          is_latest: true,
          revision_date: new Date().toISOString(),
          uploaded_by: userEmail,
          created_by: userEmail,
          updated_by: userEmail,
          changes_from_previous: null
        };

        const { error: insertError } = await supabaseClient
          .from('purchasing_orders')
          .insert([newOrder]);

        if (insertError) {
          console.error(`Ekleme hatasƒ± (${orderKey}):`, insertError);
          results.errors.push({ order: orderKey, error: insertError.message });
        } else {
          results.inserted++;
          console.log(`‚ûï Yeni sipari≈ü: ${orderKey}`);
        }

      } else {
        // MEVCUT Sƒ∞PARƒ∞≈û - Deƒüi≈üiklik kontrol√º yap
        const changes = detectChanges(existing, order);

        if (Object.keys(changes).length === 0) {
          // DEƒûƒ∞≈ûƒ∞KLƒ∞K YOK - Hi√ßbir ≈üey yapma
          results.unchanged++;
          console.log(`‚è≠Ô∏è Deƒüi≈üiklik yok: ${orderKey}`);

        } else {
          // DEƒûƒ∞≈ûƒ∞KLƒ∞K VAR - Yeni revizyon olu≈ütur

          // 1. Eski kaydƒ± g√ºncelle (is_latest = false)
          const { error: updateError } = await supabaseClient
            .from('purchasing_orders')
            .update({ is_latest: false })
            .eq('id', existing.id);

          if (updateError) {
            console.error(`G√ºncelleme hatasƒ± (${orderKey}):`, updateError);
            results.errors.push({ order: orderKey, error: updateError.message });
            continue;
          }

          // 2. Yeni revizyon ekle
          const newRevision = {
            ...order,
            revision_number: existing.revision_number + 1,
            is_latest: true,
            revision_date: new Date().toISOString(),
            uploaded_by: userEmail,
            created_by: existing.created_by, // ƒ∞lk olu≈üturanƒ± koru
            updated_by: userEmail,
            changes_from_previous: changes
          };

          const { error: revisionError } = await supabaseClient
            .from('purchasing_orders')
            .insert([newRevision]);

          if (revisionError) {
            console.error(`Revizyon hatasƒ± (${orderKey}):`, revisionError);
            results.errors.push({ order: orderKey, error: revisionError.message });

            // Rollback: Eski kaydƒ± tekrar latest yap
            await supabaseClient
              .from('purchasing_orders')
              .update({ is_latest: true })
              .eq('id', existing.id);
          } else {
            results.updated++;
            console.log(`üîÑ G√ºncellendi (v${newRevision.revision_number}): ${orderKey}`, changes);
          }
        }
      }

    } catch (err) {
      console.error('Beklenmeyen hata:', err);
      results.errors.push({ order: order.siparis_no, error: err.message });
    }
  }

  return results;
}

// ƒ∞ki sipari≈ü arasƒ±ndaki farklarƒ± tespit et
function detectChanges(oldOrder, newOrder) {
  const changes = {};

  // Kontrol edilecek alanlar
  const fieldsToCheck = [
    'gelen_miktar', 'miktar', 'birim_fiyat', 'tutar_tl', 'net', 'brut',
    'odeme_kosulu', 'vade_gun', 'vadeye_gore', 'teslim_tarihi',
    'kdv_orani', 'kur', 'malzeme_tanimi', 'tedarikci_tanimi',
    'depo', 'aciklama', 'teslimat', 'baslama', 'ozel_stok'
  ];

  for (const field of fieldsToCheck) {
    const oldValue = oldOrder[field];
    const newValue = newOrder[field];

    // Null ve undefined'ƒ± e≈üit say
    if ((oldValue === null || oldValue === undefined) &&
        (newValue === null || newValue === undefined)) {
      continue;
    }

    // Deƒüerler farklƒ±ysa kaydet
    if (oldValue !== newValue) {
      // Sayƒ±sal alanlar i√ßin tolerans
      if (typeof oldValue === 'number' && typeof newValue === 'number') {
        if (Math.abs(oldValue - newValue) < 0.01) continue; // 1 kuru≈ü farkƒ± ignore et
      }

      changes[field] = {
        from: oldValue,
        to: newValue
      };
    }
  }

  return changes;
}

function parseCSV(text) {
  // Canias ERP CSV format'ƒ± i√ßin √∂zelle≈ütirilmi≈ü parsing
  // Ayƒ±rƒ±cƒ±: noktalƒ± virg√ºl (;)

  function parseCSVLine(line, delimiter = ';') {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      const nextChar = line[i + 1];

      if (char === '"') {
        if (inQuotes && nextChar === '"') {
          current += '"';
          i++; // Skip next quote
        } else {
          inQuotes = !inQuotes;
        }
      } else if (char === delimiter && !inQuotes) {
        result.push(current.trim());
        current = '';
      } else {
        current += char;
      }
    }
    result.push(current.trim());
    return result;
  }

  // BOM karakterini temizle (UTF-8 BOM: Ôªø)
  text = text.replace(/^\uFEFF/, '');

  const lines = text.split('\n').filter(line => line.trim());
  if (lines.length === 0) {
    throw new Error('CSV dosyasƒ± bo≈ü');
  }

  // Canias formatƒ± - noktalƒ± virg√ºl ile ayrƒ±lmƒ±≈ü
  const headers = parseCSVLine(lines[0], ';').map(h => h.trim().replace(/^"|"$/g, ''));
  console.log('üìã CSV Headers:', headers);

  const orders = [];
  for (let i = 1; i < lines.length; i++) {
    const values = parseCSVLine(lines[i], ';');
    const order = {};

    headers.forEach((header, index) => {
      let value = values[index]?.trim().replace(/^"|"$/g, '') || null;

      // Canias ERP field mapping
      const fieldMapping = {
        'Teslimat': 'teslimat',
        'Baslama': 'baslama',
        'Firma': 'firma',
        'SiparisTip': 'siparis_tip',
        'SiparisNo': 'siparis_no',
        'SiparisTarihi': 'siparis_tarihi',
        'SiparisKalemi': 'siparis_kalemi',
        'Malzeme': 'malzeme',
        'MalzemeTanimi': 'malzeme_tanimi',
        'Birim': 'birim',
        'Depo': 'depo',
        'MalzemeGrubu': 'malzeme_grubu',
        'Marka': 'marka',
        'TedarikciKodu': 'tedarikci_kodu',
        'TedarikciTanimi': 'tedarikci_tanimi',
        'TeslimTarihi': 'teslim_tarihi',
        'OzelStok': 'ozel_stok',
        'Miktar': 'miktar',
        'GelenMiktar': 'gelen_miktar',
        'BirimFiyat': 'birim_fiyat',
        'Brut': 'brut',
        'NET': 'net',
        'Kur': 'kur',
        'KDVOrani': 'kdv_orani',
        'Aciklama': 'aciklama',
        'OdemeKosulu': 'odeme_kosulu',
        'IstekTipi': 'istek_tipi',
        'IstekNo': 'istek_no',
        'IstekTeslimTarihi': 'istek_teslim_tarihi',
        'TutarTL': 'tutar_tl',
        'VADEGUN': 'vade_gun',
        'VADEYEGORE': 'vadeye_gore',
        'Fark': 'fark',
        'DepoFark': 'depo_fark',
        'Bu hafta': 'bu_hafta',
        'Bu Ay': 'bu_ay',
        'Tip': 'tip'
      };

      const dbField = fieldMapping[header] || header.toLowerCase()
        .replace(/ /g, '_')
        .replace(/[√∂√ñ]/g, 'o')
        .replace(/[√º√ú]/g, 'u')
        .replace(/[≈ü≈û]/g, 's')
        .replace(/[ƒ±ƒ∞I]/g, 'i')
        .replace(/[ƒüƒû]/g, 'g')
        .replace(/[√ß√á]/g, 'c');

      // Bo≈ü string'leri null yap
      if (value === '' || value === '-' || value === 'Hic') {
        value = null;
      }

      // Tarih formatƒ±nƒ± d√∂n√º≈üt√ºr (Canias: 4.10.2025 -> PostgreSQL: 2025-10-04)
      if ((dbField === 'siparis_tarihi' || dbField === 'teslim_tarihi' ||
           dbField === 'istek_teslim_tarihi' || dbField === 'vadeye_gore') && value) {
        const dateParts = value.split('.');
        if (dateParts.length === 3) {
          const day = dateParts[0].padStart(2, '0');
          const month = dateParts[1].padStart(2, '0');
          const year = dateParts[2];
          value = `${year}-${month}-${day}`;
        }
      }

      // Sayƒ±sal deƒüerleri d√∂n√º≈üt√ºr (Canias: 3,9031 -> PostgreSQL: 3.9031)
      if ((dbField === 'miktar' || dbField === 'gelen_miktar' || dbField === 'birim_fiyat' ||
           dbField === 'brut' || dbField === 'net' || dbField === 'tutar_tl' ||
           dbField === 'kdv_orani' || dbField === 'vade_gun' || dbField === 'fark' ||
           dbField === 'depo_fark') && value) {
        value = value.replace(/\./g, '').replace(',', '.');
      }

      order[dbField] = value;
    });

    // Ge√ßerli sipari≈ü kontrol√º - en az sipari≈ü no veya tedarik√ßi olmalƒ±
    const isValidOrder = (
      (order.siparis_no && order.siparis_no !== '-') ||
      (order.tedarikci_tanimi && order.tedarikci_tanimi !== '-') ||
      (order.malzeme_tanimi && order.malzeme_tanimi !== '-')
    );

    if (isValidOrder) {
      orders.push(order);
    }
  }

  console.log(`üì¶ ${orders.length} adet sipari≈ü parse edildi`);
  if (orders.length > 0) {
    console.log('üìù ƒ∞lk sipari≈ü √∂rneƒüi:', orders[0]);
  }

  return orders;
}

// =====================================================
// YARDIMCI FONKSƒ∞YONLAR
// =====================================================

function formatCurrency(value) {
  if (!value && value !== 0) return '-';
  return new Intl.NumberFormat('tr-TR', {
    style: 'currency',
    currency: 'TRY',
    minimumFractionDigits: 2
  }).format(value);
}

function formatNumber(value) {
  if (!value && value !== 0) return '-';
  return new Intl.NumberFormat('tr-TR').format(value);
}

function formatDate(dateStr) {
  if (!dateStr) return '-';
  const date = new Date(dateStr);
  return new Intl.DateTimeFormat('tr-TR').format(date);
}

function formatVadeDate(dateStr) {
  if (!dateStr) return '-';

  const vadeDate = new Date(dateStr);
  const today = new Date();
  today.setHours(0, 0, 0, 0);
  vadeDate.setHours(0, 0, 0, 0);

  // Fark hesapla (g√ºn cinsinden)
  const diffTime = vadeDate - today;
  const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));

  // Tarih formatƒ±
  const formattedDate = new Intl.DateTimeFormat('tr-TR').format(vadeDate);

  // Renk ve stil belirleme
  let className = 'vade-date';
  let label = '';

  if (diffDays < 0) {
    // Ge√ßmi≈ü - Kƒ±rmƒ±zƒ± (Acil!)
    className += ' vade-overdue';
    label = `(${Math.abs(diffDays)} g√ºn ge√ßti)`;
  } else if (diffDays === 0) {
    // Bug√ºn - Turuncu
    className += ' vade-today';
    label = '(BUG√úN)';
  } else if (diffDays <= 7) {
    // 1-7 g√ºn - Sarƒ± (Yakla≈üƒ±yor)
    className += ' vade-near';
    label = `(${diffDays} g√ºn)`;
  } else if (diffDays <= 30) {
    // 8-30 g√ºn - A√ßƒ±k Ye≈üil
    className += ' vade-medium';
    label = `(${diffDays} g√ºn)`;
  } else {
    // 30+ g√ºn - Ye≈üil (Uzak)
    className += ' vade-far';
    label = `(${diffDays} g√ºn)`;
  }

  return `<span class="${className}">${formattedDate} <small>${label}</small></span>`;
}

function getOrderStatus(order) {
  const miktar = parseFloat(order.miktar) || 0;
  const gelen = parseFloat(order.gelen_miktar) || 0;

  if (gelen === 0) {
    return '<span style="color:#f57c00; font-weight:600;">Beklemede</span>';
  } else if (gelen < miktar) {
    return '<span style="color:#1976d2; font-weight:600;">Kƒ±smi Geldi</span>';
  } else {
    return '<span style="color:#2e7d32; font-weight:600;">Tamamlandƒ±</span>';
  }
}

// =====================================================
// SAYFA A√áILDIƒûINDA VERƒ∞LERƒ∞ Y√úKLE
// =====================================================

// showSection('purchasing') √ßaƒürƒ±ldƒ±ƒüƒ±nda bu fonksiyon otomatik √ßalƒ±≈üacak
// main.js'deki showSection fonksiyonuna hook eklemek gerekebilir

console.log('‚úÖ Purchasing mod√ºl√º y√ºklendi');
